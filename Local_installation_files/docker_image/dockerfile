# 1. Base image: Airflow 3.0.2 on Python 3.9
FROM apache/airflow:3.0.2-python3.9

# 2. Build-time args for the matching constraints URL
ARG AIRFLOW_VERSION=3.0.2
ARG CONSTRAINT_URL="https://raw.githubusercontent.com/apache/airflow/constraints-${AIRFLOW_VERSION}/constraints-3.9.txt"

# 3. Install OS-level deps as root
USER root
RUN apt-get update && \
    apt-get install -y \
      build-essential \
      git \
      curl \
      libpq-dev \
      default-libmysqlclient-dev \
      libssl-dev \
      libffi-dev \
    && rm -rf /var/lib/apt/lists/*

# 4. Switch to the airflow user for Python installs
USER airflow

# 5. Install your extras under Airflowâ€™s pinned constraints
COPY requirements.txt /tmp/requirements.txt
RUN pip install \
      --no-cache-dir \
      -r /tmp/requirements.txt \
      --constraint "${CONSTRAINT_URL}" \
    && pip check
